#include "bongocat.h"
#define BONGOCAT_PAW_DELAY 50
#define BONGOCAT_IDLE_LENGTH 6
#define BONGOCAT_IDLE_INTERVAL 150
#define BONGOCAT_RESET_DELAY 500
static bool     bongo_left              = false;
static bool     bongo_right             = false;
static uint8_t  bongo_anim_frame        = 0;
static uint16_t bongo_left_timer        = 0;
static uint16_t bongo_right_timer       = 0;
static uint16_t bongo_left_reset_timer  = 0;
static uint16_t bongo_right_reset_timer = 0;
static uint16_t bongo_anim_timer        = 0;
static uint8_t  bongo_idle_frame_map[]  = {0, 0, 1, 2, 0, 0};
static uint16_t pressed_left            = 0;
static uint16_t pressed_right           = 0;

static void bongocat_draw_cat(uint8_t version) {
    static const char PROGMEM images[][128] = {{// 'idle', 32x128px
                                                0x00, 0x80, 0x40, 0x40, 0x80, 0x20, 0x10, 0x0e, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x78, 0x80, 0x00, 0x00, 0x7f, 0x40, 0x40, 0x40, 0x41, 0x42, 0x40, 0x80, 0x83, 0x83, 0x80, 0x80, 0x84, 0x08, 0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0xf0, 0x08, 0x04, 0x04, 0x18, 0x20, 0x03, 0x3c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
                                               {// 'breathe', 32x128px
                                                0x00, 0x80, 0x40, 0x40, 0x80, 0x40, 0x20, 0x1c, 0x02, 0x02, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x10, 0x10, 0x10, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0xf0, 0x00, 0x00, 0x00, 0x7f, 0x40, 0x40, 0x40, 0x41, 0x42, 0x40, 0x80, 0x86, 0x86, 0x80, 0x80, 0x88, 0x10, 0x10, 0x20, 0x20, 0x10, 0x00, 0x00, 0x18, 0x18, 0x00, 0xf0, 0x08, 0x04, 0x04, 0x18, 0x20, 0x07, 0x78, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
                                               {// 'ears', 32x128px
                                                0x00, 0x80, 0x40, 0x40, 0x80, 0x20, 0x1e, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x08, 0x04, 0x04, 0xf8, 0x00, 0x00, 0x7f, 0x40, 0x40, 0x40, 0x41, 0x42, 0x40, 0x80, 0x83, 0x83, 0x80, 0x80, 0x84, 0x08, 0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0xf0, 0x08, 0x04, 0x04, 0x18, 0x20, 0x03, 0x3c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
                                               {// 'right', 32x128px
                                                0x00, 0x80, 0x40, 0x40, 0x80, 0x20, 0x10, 0x0e, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x78, 0x80, 0x00, 0x00, 0x7f, 0x40, 0x40, 0x40, 0x41, 0x42, 0x40, 0x80, 0x83, 0x83, 0x80, 0x80, 0x84, 0x08, 0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x3c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x82, 0x02, 0x02, 0x3c, 0x40, 0x40, 0x40, 0x20, 0x10, 0x08, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00},
                                               {// 'left', 32x128px
                                                0x00, 0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x0e, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x78, 0x80, 0x00, 0x00, 0xf8, 0x04, 0x03, 0x00, 0x00, 0x00, 0x80, 0x80, 0x83, 0x83, 0x80, 0x80, 0x84, 0x08, 0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0xf0, 0x08, 0x04, 0x04, 0x18, 0x20, 0x03, 0x3c, 0xc0, 0x23, 0x04, 0x08, 0xc8, 0x06, 0x01, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
                                               {// 'both', 32x128px
                                                0x00, 0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x0e, 0x01, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x08, 0x08, 0x08, 0x08, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x78, 0x80, 0x00, 0x00, 0xf8, 0x04, 0x03, 0x00, 0x00, 0x00, 0x80, 0x80, 0x83, 0x83, 0x80, 0x80, 0x84, 0x08, 0x08, 0x10, 0x10, 0x08, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x3c, 0xc0, 0x23, 0x04, 0x08, 0xc8, 0x06, 0x01, 0x20, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x82, 0x02, 0x02, 0x3c, 0x40, 0x40, 0x40, 0x20, 0x10, 0x08, 0x08, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00}};
    oled_write_raw_P(images[version], sizeof(images[0]));
}

void bongocat_process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (record->event.key.row <= 4) {
        if (record->event.pressed) {
            pressed_left++;
            bongo_left_reset_timer = timer_read();
            if (pressed_left == 1) {
                bongo_left = true;
            } else {
                bongo_left       = false;
                bongo_left_timer = timer_read();
            }
        } else {
            if (pressed_left == 0) return;
            pressed_left--;
            if (pressed_left == 0) {
                bongo_left       = false;
                bongo_left_timer = 0;
            }
        }
    } else {
        if (record->event.pressed) {
            pressed_right++;
            bongo_right_reset_timer = timer_read();
            if (pressed_right == 1) {
                bongo_right = true;
            } else {
                bongo_right       = false;
                bongo_right_timer = timer_read();
            }
        } else {
            if (pressed_right == 0) return;
            pressed_right--;
            if (pressed_right == 0) {
                bongo_right       = false;
                bongo_right_timer = 0;
            }
        }
    }
}

void bongocat_render() {
    if (timer_elapsed(bongo_anim_timer) > BONGOCAT_IDLE_INTERVAL) {
        bongo_anim_frame = (bongo_anim_frame + 1) % BONGOCAT_IDLE_LENGTH;
        bongo_anim_timer = timer_read();
    }

    if (bongo_left_timer > 0 && timer_elapsed(bongo_left_timer) > BONGOCAT_PAW_DELAY) {
        bongo_left_timer = 0;
        bongo_left       = true;
    }
    if (bongo_right_timer > 0 && timer_elapsed(bongo_right_timer) > BONGOCAT_PAW_DELAY) {
        bongo_right_timer = 0;
        bongo_right       = true;
    }
    if (bongo_right_reset_timer > 0 && timer_elapsed(bongo_right_reset_timer) > BONGOCAT_RESET_DELAY) {
        pressed_right           = 0;
        bongo_right_reset_timer = 0;
        bongo_right             = false;
    }
    if (bongo_left_reset_timer > 0 && timer_elapsed(bongo_left_reset_timer) > BONGOCAT_RESET_DELAY) {
        pressed_left           = 0;
        bongo_left_reset_timer = 0;
        bongo_left             = false;
    }

    if (!bongo_left && !bongo_right) {
        bongocat_draw_cat(bongo_idle_frame_map[bongo_anim_frame]);
    } else if (bongo_left && bongo_right) {
        bongo_anim_frame = 0;
        bongocat_draw_cat(5);
    } else if (bongo_left) {
        bongo_anim_frame = 0;
        bongocat_draw_cat(4);
    } else {
        bongo_anim_frame = 0;
        bongocat_draw_cat(3);
    }
}
